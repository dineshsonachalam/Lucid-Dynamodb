name: Test

on:
  push:
    branches:
      - master
    tags:
      - latest

jobs:

  integration-tests:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2
        - name: Start integration test
          env: 
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          run: |
            pip3 install -r requirements-dev.txt
            python setup.py install
            pytest -s
  
  deploy-to-pypi:
      needs: integration-tests
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2
        - name: Install package dependencies
          run: pip3 install -r requirements-dev.txt

        - name: Build python package and deploy to PYPI
          run: |
            rm -rf build dist *.egg-info
            python3 setup.py sdist bdist_wheel
            twine upload --username ${{ secrets.PYPI_USERNAME }} --password ${{ secrets.PYPI_PASSWORD }} --skip-existing dist/*

  
